# 工作日志 2026-03-01

## 一、今日完成

### 1. AI Phase 2 部署（Cloudflare 基础设施配置）

- **D1 迁移**：在 Cloudflare Dashboard D1 Console 执行 `0004_ai_tables.sql`，创建 3 张 AI 功能表：
  - `ai_rate_limits` — IP 限流
  - `ai_summaries` — 摘要缓存
  - `ai_embedding_jobs` — 嵌入任务追踪
- **环境变量**：在 amituofo Pages 项目设置中添加：
  - `ADMIN_TOKEN`（密钥类型）
  - `ALLOWED_ORIGINS`：`https://foyue.org,https://amituofo.pages.dev,https://bojingji.pages.dev`
- **绑定配置**：
  - D1 数据库：`DB` → `foyue-db`（已有）
  - Workers AI：`AI` → Workers AI 目录（新增）
  - Vectorize：`VECTORIZE` → `dharma-content`（新增）

### 2. 文稿关联（auto-match）

调用 `POST /api/admin/transcript/auto-match` 成功：
- 自动匹配 **7 个音频系列**，更新 **36 篇文档** 的 `audio_series_id` 和 `audio_episode_num`
- 匹配结果：
  - 大势至菩萨念佛圆通章 → dashizhi-yuantongzhang
  - 阿弥陀佛四十八大愿 → amituo-sishiba-dayuan
  - 劝发菩提心文 → quanfa-putixin-wen
  - 西方确指 → xifang-quezhi
  - 净土十疑论 → jingtu-shiyi-lun
  - 与大兴善寺体安和尚书 → yu-daxingshansi-tianan
  - 复高邵麟居士书四 → fu-gaoshaolin-jushi-shu-si
- 仍有 20 个 wenku 系列未匹配（需要人工确认对应关系）

### 3. Vectorize 索引重建

发现维度不匹配问题：
- 原索引：1024 维（为 PLaMo-Embedding-1B 创建）
- BGE-M3 模型输出：768 维
- **解决**：删除旧索引，重建为 768 维 cosine 索引
- Dashboard 绑定确认三项均正常（DB、AI、VECTORIZE）

### 4. Embedding 模型调整

| 提交 | 变更 | 原因 |
|------|------|------|
| `0866e74` | embeddings/build 分批处理 | Workers 50 子请求限制 |
| `a6f5007` | 移除 AI Gateway 配置 | gateway 可能不存在导致错误 |
| `b2b1827` | 换用 PLaMo-Embedding-1B | 1024 维匹配原索引 |
| `c08d071` | 换回 BGE-M3 (768维) | PLaMo 收费，用户要求免费模型 |
| `22ed83f` | 添加诊断端点 | 排查 3043 inference error |

### 5. 文稿嵌入功能（前端 + 后端，前一天完成并部署）

- 后端 3 个 API：获取文稿、可用性检查、管理员填充
- 前端组件：`transcript.js` — 懒加载文稿、展开/收起动画
- 集成到 `pages-category.js` 的集数列表中
- CSS 样式 + 中/英/法三语 i18n

## 二、未完成 / 待解决

### 向量嵌入构建失败

**现象**：调用 `POST /api/admin/embeddings/build` 时，所有文档均报 `3043: inference error`

**已排除**：
- ~~AI Gateway 不存在~~ — 已移除 gateway 配置，仍报错
- ~~模型路径错误~~ — BGE-M3 路径 `@cf/baai/bge-m3` 是官方标准路径
- ~~维度不匹配~~ — Vectorize 索引已重建为 768 维

**待排查**：
- 已添加诊断端点 `GET /api/admin/test-embedding?token=xxx`，用最简短文本（"南无阿弥陀佛"）直接调用 BGE-M3，部署后可测试
- 可能原因：
  1. BGE-M3 在当前账户/区域暂时不可用
  2. Workers AI 服务端临时故障
  3. Pages Functions 与 Workers AI 绑定的兼容性问题

**下一步**：
1. 部署诊断端点后测试模型是否可用
2. 如 BGE-M3 确实不可用，考虑换用 `@cf/baai/bge-base-en-v1.5`（768维，免费）或 `@cf/baai/bge-small-en-v1.5`（384维，免费，需重建索引）
3. 成功后循环调用 `?limit=3&offset=0` 逐批处理 249 个文档

### 未匹配的文库系列

auto-match 只匹配了 7/27 个系列（36/249 篇文档）。剩余 20 个系列需要人工确认 wenku `series_name` 与 foyue `series.id` 的对应关系，通过 `POST /api/admin/transcript/populate` 手动填充。

## 三、当前部署状态

- **生产环境**：`amituofo.pages.dev` / `foyue.org`
- **最新提交**：`c08d071`（已部署成功）
- **待部署**：`22ed83f`（诊断端点，未推送）
- **D1 表**：9 张表正常（含 3 张 AI 表）
- **Vectorize**：`dharma-content` 索引，768维 cosine，空（0 条向量）
